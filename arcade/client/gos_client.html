<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
	<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <title>"test"</title>
  </head>
  <body>
    <div id="signdiv">
      username: <input id="username" type="text"></input><br>
      password: <input id="password" type="password"></input>
      <button id="signin">Sign In</button>
      <button id="signup">Sign Up</button>
    </div>
    <div id="gamediv" style="display:none;">
      <canvas id="ctx" width="256" height="256"></canvas>
      <div>
        <input id="build1" type="radio" name="build" value="residential">
        <label for="build1">Жилая зона</label><br>
        <input id="build2" type="radio" name="build" value="industrial">
        <label for="build2">Промышленная зона</label><br>
        <input id="build3" type="radio" name="build" value="military">
        <label for="build3">Военная база</label><br>
      </div>
      <br>
      <div id="all_mess" style="width:500px;height:100px;overflow-y:scroll"></div>
      <br>
      <input id="msg" type="text" style="width:400px"></input>
      <button id="sendmsg" style="width:100px">send</button>
    </div>
  </body>
</html>

<script src="/socket.io/socket.io.js"></script>
<script>
  var socket = io();
  var user;

  var signdiv = document.getElementById('signdiv');
  var username = document.getElementById('username');
  var password = document.getElementById('password');
  var signin = document.getElementById('signin');
  var signup = document.getElementById('signup');
  var sendmsg = document.getElementById('sendmsg');
  var msg = document.getElementById('msg');
  var all_mess = document.getElementById('all_mess');
  var build = document.getElementsByName('build');


  signin.onclick = function() {
    socket.emit("signin", {name:username.value, pass:password.value});
    user = username.value;
  };
  signup.onclick = function() {
    socket.emit("signup", {name:username.value, pass:password.value});
    user = username.value;
  };

  socket.on("signinResponce", function(data) {
    if(data.success) {
      signdiv.style.display = 'none';
      gamediv.style.display = 'inline-block';
    }
    else {
      alert("sign in failed");
    }
  });

  socket.on("signupResponce", function(data) {
    if(data.success) {
      signdiv.style.display = 'none';
      gamediv.style.display = 'inline-block';
    }
    else {
      alert("sign up failed");
    }
  });

  socket.on("add msg", function(data) {
    //all_mess.append(data.name + ": " + data.message + "<br>");
    all_mess.innerHTML += '<div>' + data.name + ": " + data.message + "</div>"
  });

  const canvas = document.getElementById('ctx');
  const ctx = canvas.getContext("2d");
  let box = 16;
  //const unit = new Image();
  const city = new Image();
  const chunk = new Image();
  //unit.src = "client/img/unit.png";
  city.src = "client/img/city.png";
  chunk.src = "client/img/chunk.png";
  ctx.font = '30px Arial';

  // canvas.onclick = function() {
  //   if (build[0].checked) {
  //     //alert(Math.floor((event.pageX-8)/16)+':'+Math.floor((event.pageY-8)/16));
  //     socket.emit("newbuild", {x:Math.floor((event.offsetX)/16), y:Math.floor((event.offsetY)/16), type:0});
  //   }
  //   else if (build[1].checked) {
  //     socket.emit("newbuild", {x:Math.floor((event.offsetX)/16), y:Math.floor((event.offsetY)/16), type:1});
  //   }
  //   else if (build[2].checked) {
  //     socket.emit("newbuild", {x:Math.floor((event.offsetX)/16), y:Math.floor((event.offsetY)/16), type:3});
  //   }
  // }

  sendmsg.onclick = function() {
    socket.emit('send msg', {message:msg.value, name:user});
  }

  // city.onload = function() {
  //   socket.emit('citymap');
  // }
  chunk.onload = function() {
    socket.emit('chunk');
  }

  socket.on('citymap', function(data) {
    for (var i = 0; i < box; i++) {
      for (var j = 0; j < box; j++) {
        if (data[i][j] === 0) {
          //ctx.fillRect(box*i, box*j, box, box);
          //ctx.drawImage(unit, box*i, box*j);
          ctx.drawImage(city, box*0, box*0, box, box, box*i, box*j, box, box);
        }
        else if (data[i][j] === 1) {
          ctx.drawImage(city, box*1, box*0, box, box, box*i, box*j, box, box);
        }
        else if (data[i][j] === 2) {
          ctx.drawImage(city, box*0, box*1, box, box, box*i, box*j, box, box);
        }
        else if (data[i][j] === 3) {
          ctx.drawImage(city, box*1, box*1, box, box, box*i, box*j, box, box);
        }
      }
    }
    ctx.strokeStyle="#FF0000";
    ctx.lineWidth=2;
    for (var i = 0; i < 15; i++) {
      for (var j = 0; j < 15; j++) {
        if (data[i][j] != data[i+1][j]) {
          ctx.beginPath();
          ctx.moveTo((i*box)+box,j*box);
          ctx.lineTo((i*box)+box,(j*box)+box);
          ctx.stroke();
        }
        if (data[i][j] != data[i][j+1]) {
          ctx.beginPath();
          ctx.moveTo((i*box),(j*box)+box);
          ctx.lineTo((i*box)+box,(j*box)+box);
          ctx.stroke();
        }
      }
    }
	});


  socket.on('chunk', function(data) {
    for (var i = 0; i < box; i++) {
      for (var j = 0; j < box; j++) {
        if (data[i][j].relief === 0) {
          ctx.drawImage(chunk, box*0, box*0, box, box, box*i, box*j, box, box);
        }
        else if (data[i][j].relief === 1) {
          ctx.drawImage(chunk, box*1, box*0, box, box, box*i, box*j, box, box);
        }
        else if (data[i][j].relief === 2) {
          ctx.drawImage(chunk, box*0, box*1, box, box, box*i, box*j, box, box);
        }
        else if (data[i][j].relief === 3) {
          ctx.drawImage(chunk, box*1, box*1, box, box, box*i, box*j, box, box);
        }
      }
    }
    ctx.strokeStyle="#FF0000";
    ctx.lineWidth=2;
    for (var i = 0; i < 15; i++) {
      for (var j = 0; j < 15; j++) {
        if (data[i][j].owner != data[i+1][j].owner) {
          ctx.beginPath();
          ctx.moveTo((i*box)+box,j*box);
          ctx.lineTo((i*box)+box,(j*box)+box);
          ctx.stroke();
        }
        if (data[i][j].owner != data[i][j+1].owner) {
          ctx.beginPath();
          ctx.moveTo((i*box),(j*box)+box);
          ctx.lineTo((i*box)+box,(j*box)+box);
          ctx.stroke();
        }
      }
    }
	});
</script>
